#!/usr/bin/env bash
# -*- bash -*-
#
#
VER="$1"
shift
set -u -e -o pipefail

RUBY_SETUP_BIN=="/apps/ruby_setup/bin"


# === https://github.com/wayneeseguin/rvm/blob/master/scripts/functions/requirements/ubuntu 
if [[ -d /progs/ruby-build ]]
then
  sudo apt-get upgrade
else
  echo "=== Updating system using apt-get:"
  sudo apt-get install git      \
    curl gawk zlib1g-dev        \
    build-essential libssl-dev  \
    libreadline-dev libyaml-dev \
    libsqlite3-dev sqlite3      \
    libxml2-dev libxslt-dev     \
    bash curl patch bzip2 ca-certificates gawk                        \
    g++ gcc make libc6-dev patch openssl ca-certificates libreadline6 \
    libreadline6-dev curl zlib1g zlib1g-dev libssl-dev libyaml-dev    \
    libsqlite3-dev sqlite3 autoconf                                   \
    libgdbm-dev libncurses5-dev automake libtool bison pkg-config libffi-dev
fi



# ================ Ensure ruby-build is installed: ====
cd /progs
if [[ -d ruby-build ]]; then
  cd ruby-build
  git pull
else
  git clone https://github.com/sstephenson/ruby-build.git
  cd ruby-build
  PREFIX=/progs ./install.sh
fi
# =====================================================

# === Is version set? If not, find latest ruby version.
if [[ -z "$VER" ]]
then
  VER="$(ruby-build --definitions | grep '^[0-9]\+\.[0-9]\+\.[0-9]\+$' | tail -n 1)"
fi

DEST=/progs/ruby/$VER

# === Ensure dir does not already exist.
if [[ -d $DEST ]]
then
  echo -e "\n=== Dir already exists: $DEST"
  echo -e "  Remove it first, then come back."
  exit 1
fi

# ================ The Main Show ======================
CONFIGURE_OPTS="--enable-shared --disable-install-doc" bin/ruby-build -v $VER /progs/ruby/$VER "$@"
# =====================================================

# ================ GEM-related ========================
$DEST/bin/gem update --no-document
$DEST/bin/gem update --system
$DEST/bin/gem install bundler     --no-document
$DEST/bin/gem install bump        --no-document --ri
$DEST/bin/gem install gem-release --no-document --ri
# =====================================================

echo -e "\n==== Done: $DEST/bin/ruby \n"
$DEST/bin/ruby -v

$RUBY_SETUP_BIN/gemrc_config

if [[ ! -d /progs/ruby/current ]]
then
  $RUBY_SETUP_BIN/mk_ruby_current $VER
fi


