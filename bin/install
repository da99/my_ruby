#!/usr/bin/env bash
# -*- bash -*-
#
#
set -u -e -o pipefail

VER="$1"
shift

DEST=/progs/ruby/$VER



# === https://github.com/wayneeseguin/rvm/blob/master/scripts/functions/requirements/ubuntu 
echo "=== Updating system using apt-get:"
sudo apt-get update
sudo apt-get install git-core \
 curl gawk zlib1g-dev        \
 build-essential libssl-dev  \
 libreadline-dev libyaml-dev \
 libsqlite3-dev sqlite3      \
 libxml2-dev libxslt-dev     \
bash curl patch bzip2 ca-certificates gawk \
g++ gcc make libc6-dev patch openssl ca-certificates libreadline6 \
libreadline6-dev curl zlib1g zlib1g-dev libssl-dev libyaml-dev \
libsqlite3-dev sqlite3 autoconf \
libgdbm-dev libncurses5-dev automake libtool bison pkg-config libffi-dev



# ================ Ensure ruby-build is installed: ====
cd /progs
if [[ -d ruby-build ]]; then
  cd ruby-build
  git pull
else
  git clone https://github.com/sstephenson/ruby-build.git
  cd ruby-build
  PREFIX=/progs ./install.sh
fi
# =====================================================

# ================ The Main Show ======================
CONFIGURE_OPTS="--enable-shared --disable-install-doc" bin/ruby-build -v $VER /progs/ruby/$VER "$@"
# =====================================================

# ================ GEM-related ========================
$DEST/bin/gem update --no-document
$DEST/bin/gem update --system
$DEST/bin/gem install bundler     --no-document
$DEST/bin/gem install bump        --no-document --ri
$DEST/bin/gem install gem-release --no-document --ri
# =====================================================

echo -e "\n==== Done: $DEST/bin/ruby \n"
$DEST/bin/ruby -v

/apps/boot_ups/bin/install/gemrc_config


