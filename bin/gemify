#!/usr/bin/env bash
# -*- bash -*-
#

set -u -e -o pipefail

ME="gemify"
DIR="$( basename "$(pwd)" )"
TEMPLATES="/apps/ruby_setup/templates/gem"

# === COMMAND: init
if [[ "$@" == "init" ]]; then
  __gemify_init
  exit 0
fi

function git_is_clean {
    if ! git_repo_is_clean
    then
      echo -e "\n!!! GIT repo not clean enough.\n" 1>&2
      exit 1
    fi
}

rm -f ./*.gem

case "$@" in

  "bump") # === COMMAND: bump
    git_is_clean

    bump current
    echo -e "=== Bumping...\n"
    bump $1 --no-commit --no-bundle
    VER=$(cat VERSION)

    git add    .
    git add    -u
    git commit -m   "Bump: $VER"
    git tag         "v$VER"
    ;;

  "push") # === COMMAND: push
    git_is_clean
    VER=$(cat VERSION)
    git push origin "v$VER"
    ;;

  "release") # === COMMAND: release
    git_is_clean
    $ME push
    gem build ./*.gemspec
    gem push "$(echo ./*.gem)"
    ;;

  "init") # === COMMAND: init
    if [[ "$@" == "ex" ]]; then
      echo "  $ gemify init"
      echo "  $ gemify init bitbucket"
      exit 0
    fi

    echo ""
    name="$(dirname $(pwd))"
    today="$(date +"%Y-%m-%d")"
    year="$(date +"%Y")"
    user="$(git config --global user.name)"
    email="$(git config --global user.email)"
    gemspec="${name}.gemspec"

    if [[ -z "$@" ]]; then
      repo="github"
      homepage="https://github.com/${user}/${name}"
      repo_git="git@github.com:${user}/${name}.git"
    else
      repo="bitbucket"
      homepage="https://bitbucket.org/da99/${name}"
      repo_git="git@bitbucket.org:${user}/${name}.git"
    fi

    if [[ ! -d .git ]]; then
      git init
    fi

    if [[ "$(git remote -v)" == *origin* ]]; then
      git remote remove origin
    fi

    git remote add origin $repo_git
    git branch --set-upstream master origin/master

    mkdir -p specs
    mkdir -p lib
    cp --no-clobber $TEMPLATES/Gemfile Gemfile



      update_homepage $repo
      add_dep  bacon
      add_dep  Bacon_Colored
      remove   version.rb
      add_file VERION %x(cat VERSION)
      add_origin
        url="git remote add origin ssh://github/$user/$name.git"
        git init
        git remote add origin $url
        echo -e "=== wrote: git init, origin $url"
    fi



    $green "=== Done writing: $name\n"
    ;;

esac  # === $@

